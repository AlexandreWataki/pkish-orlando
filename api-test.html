<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>PKish API – Teste Rápido</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; padding: 20px; max-width: 900px; margin: 0 auto; }
    h1 { font-size: 20px; margin-bottom: 16px; }
    .row { display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: center; margin-bottom: 10px; }
    .grid { display: grid; grid-template-columns: repeat(2, minmax(280px, 1fr)); gap: 12px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 14px; }
    label { font-size: 12px; color: #555; display: block; margin-bottom: 4px; }
    input, textarea, button, select {
      width: 100%; padding: 10px; border-radius: 10px; border: 1px solid #ccc; box-sizing: border-box;
    }
    button { cursor: pointer; }
    .btn { background: #111; color: #fff; border: none; }
    .btn:hover { filter: brightness(1.05); }
    .muted { color: #777; font-size: 12px; }
    pre { background: #0b1020; color: #d6e2ff; padding: 12px; border-radius: 8px; overflow: auto; max-height: 320px; }
    .ok { color: #1a7f37; font-weight: 600; }
    .fail { color: #b3261e; font-weight: 600; }
  </style>
</head>
<body>
  <h1>PKish API – Teste Rápido</h1>

  <div class="card">
    <div class="row">
      <div>
        <label>Base URL da API</label>
        <input id="baseUrl" value="https://pkish-api-417776644821.us-east4.run.app/api" />
        <div class="muted">Se seu server responder sem /api, troque para <code>...run.app</code> (sem <code>/api</code>).</div>
      </div>
      <div>
        <label>&nbsp;</label>
        <button class="btn" onclick="salvarBase()">Usar esta base</button>
      </div>
    </div>
    <div class="muted" id="baseInfo"></div>
  </div>

  <br/>

  <div class="grid">
    <div class="card">
      <h3>Health</h3>
      <div class="row"><button class="btn" onclick="pingApiHealth()">GET /api/health</button></div>
      <div class="row"><button onclick="pingHealth()">GET /health</button></div>
    </div>

    <div class="card">
      <h3>Google Auth</h3>
      <label>ID Token do Google (copie do app, se necessário)</label>
      <textarea id="idToken" rows="4" placeholder="cole aqui o idToken"></textarea>
      <div class="row"><button class="btn" onclick="postAuthGoogle()">POST /api/auth/google</button></div>
      <div class="muted">Se sua API não usa <code>/api</code>, troque a base na parte de cima.</div>
    </div>

    <div class="card">
      <h3>Register (usuário/senha)</h3>
      <label>username</label><input id="regUser" value="testeuser" />
      <label>email</label><input id="regEmail" value="testeuser@example.com" />
      <label>password</label><input id="regPass" type="password" value="123456" />
      <div class="row"><button onclick="postRegister()">POST /api/register</button></div>
      <div class="row"><button onclick="postAuthRegister()">POST /api/auth/register</button></div>
    </div>

    <div class="card">
      <h3>Login (usuário/senha)</h3>
      <label>username</label><input id="loginUser" value="testeuser" />
      <label>password</label><input id="loginPass" type="password" value="123456" />
      <div class="row"><button onclick="postLogin()">POST /api/login</button></div>
      <div class="row"><button onclick="postAuthLogin()">POST /api/auth/login</button></div>
      <div class="muted">O token retornado é salvo abaixo para testar <code>/api/me</code>.</div>
    </div>

    <div class="card">
      <h3>Me (Bearer token)</h3>
      <label>Token (Bearer)</label><textarea id="bearer" rows="2" placeholder="será preenchido após login/google"></textarea>
      <div class="row"><button class="btn" onclick="getMe()">GET /api/me</button></div>
      <div class="row"><button onclick="getMeNoApi()">GET /me</button></div>
    </div>

    <div class="card">
      <h3>Atalhos úteis</h3>
      <div class="row"><button onclick="curlHealth()">Copiar CURL /api/health</button></div>
      <div class="row"><button onclick="curlGoogle()">Copiar CURL /api/auth/google</button></div>
      <div class="row"><button onclick="curlLogin()">Copiar CURL /api/login</button></div>
    </div>
  </div>

  <br/>

  <div class="card">
    <h3>Resultado</h3>
    <div id="status"></div>
    <pre id="out">...</pre>
  </div>

  <script>
    let BASE = localStorage.getItem('pkish_base') || document.getElementById('baseUrl').value;

    function salvarBase() {
      BASE = document.getElementById('baseUrl').value.trim().replace(/\/+$/, '');
      localStorage.setItem('pkish_base', BASE);
      info(`Base atual: ${BASE}`);
    }

    function info(msg) {
      document.getElementById('baseInfo').textContent = msg;
    }

    function setStatus(ok, url, status) {
      const el = document.getElementById('status');
      el.innerHTML = `<span class="${ok ? 'ok':'fail'}">${ok ? 'OK':'FALHA'}</span> • ${url} • ${status}`;
    }
    function setOut(obj) {
      const el = document.getElementById('out');
      try { el.textContent = typeof obj === 'string' ? obj : JSON.stringify(obj, null, 2); }
      catch { el.textContent = String(obj); }
    }
    function bearerSet(token) {
      document.getElementById('bearer').value = token || '';
    }

    // ==== FETCH helpers com tratamento de erro ====
    async function GET(url) {
      try {
        const res = await fetch(url, { method: 'GET' });
        const text = await res.text();
        let data; try { data = JSON.parse(text); } catch { data = text; }
        setStatus(res.ok, url, `HTTP ${res.status}`);
        setOut(data);
        return { res, data };
      } catch (err) {
        setStatus(false, url, 'NETWORK/JS ERROR');
        setOut({ error: String(err) });
      }
    }
    async function POST(url, body) {
      try {
        const res = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body || {})
        });
        const text = await res.text();
        let data; try { data = JSON.parse(text); } catch { data = text; }
        setStatus(res.ok, url, `HTTP ${res.status}`);
        setOut(data);
        if (res.ok && data && data.token) bearerSet(data.token);
        return { res, data };
      } catch (err) {
        setStatus(false, url, 'NETWORK/JS ERROR');
        setOut({ error: String(err) });
      }
    }

    // ==== Botões ====
    // Health
    async function pingApiHealth() { return GET(`${BASE}/health`); } // BASE já tem /api
    async function pingHealth() { return GET(`${BASE.replace(/\/api$/,'')}/health`); }

    // Google
    async function postAuthGoogle() {
      const idToken = (document.getElementById('idToken').value || '').trim();
      if (!idToken) { setOut('Cole um idToken do Google.'); return; }
      return POST(`${BASE}/auth/google`, { idToken });
    }

    // Register / Login
    async function postRegister() {
      const u = document.getElementById('regUser').value.trim();
      const e = document.getElementById('regEmail').value.trim();
      const p = document.getElementById('regPass').value;
      return POST(`${BASE}/register`, { username: u, email: e, password: p });
    }
    async function postAuthRegister() {
      const u = document.getElementById('regUser').value.trim();
      const e = document.getElementById('regEmail').value.trim();
      const p = document.getElementById('regPass').value;
      return POST(`${BASE}/auth/register`, { username: u, email: e, password: p });
    }
    async function postLogin() {
      const u = document.getElementById('loginUser').value.trim();
      const p = document.getElementById('loginPass').value;
      return POST(`${BASE}/login`, { username: u, password: p });
    }
    async function postAuthLogin() {
      const u = document.getElementById('loginUser').value.trim();
      const p = document.getElementById('loginPass').value;
      return POST(`${BASE}/auth/login`, { username: u, password: p });
    }

    // Me
    async function getMe() {
      const token = document.getElementById('bearer').value.trim();
      const url = `${BASE}/me`;
      try {
        const res = await fetch(url, { headers: { Authorization: `Bearer ${token}` } });
        const text = await res.text();
        let data; try { data = JSON.parse(text); } catch { data = text; }
        setStatus(res.ok, url, `HTTP ${res.status}`);
        setOut(data);
      } catch (err) {
        setStatus(false, url, 'NETWORK/JS ERROR');
        setOut({ error: String(err) });
      }
    }
    async function getMeNoApi() {
      const token = document.getElementById('bearer').value.trim();
      const url = `${BASE.replace(/\/api$/,'')}/me`;
      try {
        const res = await fetch(url, { headers: { Authorization: `Bearer ${token}` } });
        const text = await res.text();
        let data; try { data = JSON.parse(text); } catch { data = text; }
        setStatus(res.ok, url, `HTTP ${res.status}`);
        setOut(data);
      } catch (err) {
        setStatus(false, url, 'NETWORK/JS ERROR');
        setOut({ error: String(err) });
      }
    }

    // Atalhos CURL
    function copy(text) {
      navigator.clipboard.writeText(text);
      setOut('CURL copiado para a área de transferência.');
    }
    function curlHealth() {
      copy(`curl -i ${BASE}/health`);
    }
    function curlGoogle() {
      const idToken = (document.getElementById('idToken').value || '').trim();
      copy(`curl -i -X POST ${BASE}/auth/google -H "Content-Type: application/json" -d '${JSON.stringify({idToken})}'`);
    }
    function curlLogin() {
      const u = document.getElementById('loginUser').value.trim();
      const p = document.getElementById('loginPass').value;
      copy(`curl -i -X POST ${BASE}/login -H "Content-Type: application/json" -d '${JSON.stringify({username:u,password:p})}'`);
    }

    // init
    document.getElementById('baseUrl').value = BASE;
    info(`Base atual: ${BASE}`);
  </script>
</body>
</html>
